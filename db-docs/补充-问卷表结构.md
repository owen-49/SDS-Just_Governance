

### 这部分是关于客户最新要求的问卷的部分，跟着项目简介一起在第一次登录时显示并请求用户填写。

#### **1. `onboarding_surveys`（问卷主表）**

用于记录每个用户的整个问卷填写记录（时间、用户、分数等）。

```sql
CREATE TABLE onboarding_surveys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    submitted_at TIMESTAMPTZ DEFAULT now(),	
    total_score INT,  -- 总得分
    level TEXT CHECK (level IN ('new', 'developing', 'strong')),  -- 等级
    UNIQUE(user_id)  
);
```

------

#### **2. `onboarding_survey_answers`（用户每题填写情况，无论单选/多选）**

按题编号或题目 key 存储结构化答案，可统计。

```sql
CREATE TABLE onboarding_survey_answers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    survey_id UUID NOT NULL REFERENCES onboarding_surveys(id) ON DELETE CASCADE,
    question_number INT NOT NULL,  -- 题目编号
    question_key TEXT NOT NULL,    -- 题目语义化key
    question_type TEXT NOT NULL CHECK (question_type IN ('single_choice','multi_choice','text')),
    answer_value TEXT,                       -- 单选题：选项 value（字符串稳定）
  	answer_text TEXT,                        -- 纯文本题，或“Other”的补充文本
  	answer_score INT,                        -- 该题折算分（便于统计）
    created_at TIMESTAMPTZ DEFAULT now()
    UNIQUE (survey_id, question_key)
);
```

------

#### **3. `onboarding_survey_options`（可选项选项值表，方便多选题）**

用于保存多选题（如兴趣领域、动机、熟悉术语等）选了哪些。

```sql
CREATE TABLE onboarding_survey_options (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    answer_id UUID NOT NULL REFERENCES onboarding_survey_answers(id) ON DELETE CASCADE,
    option_value TEXT NOT NULL,              -- 选项 value（统一用 TEXT）
    option_text TEXT,                        -- 若选择了“Other”，这里存用户输入
    created_at TIMESTAMPTZ DEFAULT now()
);
```

------

## 关系图（ER 简图）

```
users
  └── onboarding_surveys (1:1)
        └── onboarding_survey_answers (1:N)
                └── onboarding_survey_options (1:N)
```

## 一、实现建议 / 流程控制

- 用户第一次登录后，如果没有 `onboarding_surveys` 记录 → 跳转问卷页；
- 填写完成后：
  - 自动打分（逻辑在服务端算）
  - 生成 `onboarding_surveys` 一条
  - 为每题插入 `onboarding_survey_answers`
  - 如果是多选题，插入多条 `onboarding_survey_options`
- 以后如果有需要，后台就可以做统计查询，例如：
  - 哪些用户是 "Strong Understanding"
  - 哪题得分分布怎样
  - 哪些术语最陌生（根据第9题统计）

## 二、前端渲染用JSON

```json
{
  "version": 1,
  "title": "Just Governance Onboarding Survey",
  "locale": "en-AU",
  "questions": [
    {
      "number": 1,		// 题目编号
      "key": "confidence_in_boards",	// 题目语义key
      "text": "How confident do you feel in knowing what boards do?",	// 题干
      "type": "single_choice",	// 题目类型
      "options": [		// 每个选项一个label 一个value
        { "label": "Not at all confident", "value": "not_confident" },
        { "label": "Somewhat confident",  "value": "somewhat_confident" },
        { "label": "Very confident",      "value": "very_confident" }
      ]
    },
    {
      "number": 2,
      "key": "familiar_terms",
      "text": "Which of these terms are you familiar with?",
      "type": "multi_choice",
      "min_select": 0,
      "options": [
        { "label": "Incorporated bodies",     "value": "incorporated_bodies" },
        { "label": "Companies",               "value": "companies" },
        { "label": "Not for profits",         "value": "not_for_profits" },
        { "label": "Community organisations", "value": "community_orgs" },
        { "label": "Social enterprises",      "value": "social_enterprises" }
      ]
    },
    {
      "number": 3,
      "key": "interest_motivation",
      "text": "What interests you most about learning what boards do? (choose up to 2)",
      "type": "multi_choice",
      "max_select": 2,
      "options": [
        { "label": "Making a difference on an issue I care about", "value": "impact" },
        { "label": "Getting a board role",                         "value": "get_board_role" },
        { "label": "Learning new skills",                          "value": "learn_new_skills" },
        { "label": "Understanding how key decisions get made",     "value": "understand_decisions" },
        { "label": "Meeting people and building networks",         "value": "meet_and_network" },
        { "label": "Furthering my career",                         "value": "further_career" },
        { "label": "Other", "value": "other", "has_text_input": true }
      ]
    },
    {
      "number": 4,
      "key": "legal_familiarity",
      "text": "How familiar are you with Australia’s legal system, including the difference between legislation and case law?",
      "type": "single_choice",
      "options": [
        { "label": "Not familiar at all", "value": "not_familiar" },
        { "label": "Somewhat familiar",   "value": "somewhat_familiar" },
        { "label": "Very familiar",       "value": "very_familiar" }
      ]
    },
    {
      "number": 5,
      "key": "governance_idea",
      "text": "When you hear the word “governance”, what comes to mind?",
      "type": "single_choice",
      "options": [
        { "label": "Not sure yet", "value": "not_sure" },
        { "label": "A rough idea", "value": "rough_idea" },
        { "label": "Clear idea",   "value": "clear_idea" }
      ]
    },
    {
      "number": 6,
      "key": "group_decision_experience",
      "text": "Have you ever been part of a group responsible for making decisions for other people?",
      "type": "single_choice",
      "options": [
        { "label": "No, never",        "value": "no_never" },
        { "label": "Yes, a few times", "value": "yes_few_times" },
        { "label": "Yes, often",       "value": "yes_often" }
      ]
    },
    {
      "number": 7,
      "key": "interest_areas",
      "text": "Which areas interest you most?",
      "type": "multi_choice",
      "min_select": 0,
      "options": [
        { "label": "Community and social justice", "value": "community_social_justice" },
        { "label": "Sport and recreation",         "value": "sport_recreation" },
        { "label": "Arts and culture",             "value": "arts_culture" },
        { "label": "Health",                       "value": "health" },
        { "label": "Housing and homelessness",     "value": "housing_homelessness" },
        { "label": "Gender",                       "value": "gender" },
        { "label": "Women’s safety",               "value": "womens_safety" },
        { "label": "Environment",                  "value": "environment" },
        { "label": "Other", "value": "other", "has_text_input": true }
      ]
    },
    {
      "number": 8,
      "key": "financial_docs_experience",
      "text": "Have you ever read basic financial documents (budgets, annual reports, profit and loss statements)?",
      "type": "single_choice",
      "options": [
        { "label": "Never",      "value": "never" },
        { "label": "Occasionally","value": "occasionally" },
        { "label": "Often",      "value": "often" }
      ]
    },
    {
      "number": 9,
      "key": "new_terms",
      "text": "Which of these words are NEW to you? (select any that apply)",
      "type": "multi_choice",
      "min_select": 0,
      "options": [
        { "label": "Constitution",         "value": "constitution" },
        { "label": "Director",             "value": "director" },
        { "label": "Nominee",              "value": "nominee" },
        { "label": "Conflict of interest", "value": "conflict_of_interest" },
        { "label": "Agenda",               "value": "agenda" },
        { "label": "Minutes",              "value": "minutes" },
        { "label": "Fiduciary duties",     "value": "fiduciary_duties" }
      ]
    },
    {
      "number": 10,
      "key": "speak_up_comfort",
      "text": "How comfortable do you feel speaking up in a group?",
      "type": "single_choice",
      "options": [
        { "label": "Not very comfortable", "value": "not_very_comfortable" },
        { "label": "Sometimes comfortable","value": "sometimes_comfortable" },
        { "label": "Very comfortable",     "value": "very_comfortable" },
        { "label": "Not sure",             "value": "not_sure" }
      ]
    },
    {
      "number": 11,
      "key": "learn_more_about",
      "text": "Which of these do you most want to learn more about? (choose up to 2)",
      "type": "multi_choice",
      "max_select": 2,
      "options": [
        { "label": "What boards actually do",                 "value": "what_boards_do" },
        { "label": "How board decisions are made",            "value": "how_decisions_made" },
        { "label": "The legal duties and responsibilities of board members", "value": "legal_duties" },
        { "label": "How to get on a board",                   "value": "how_to_get_on_board" },
        { "label": "The different types of boards in Australia", "value": "types_of_boards_au" },
        { "label": "When a board is needed and how to set one up", "value": "when_and_how_to_set_up" },
        { "label": "Something else", "value": "other", "has_text_input": true }
      ]
    },
    {
      "number": 12,
      "key": "participation_barriers",
      "text": "Is there anything that might make it difficult for you to fully take part in this training?",
      "type": "multi_choice",
      "min_select": 0,
      "options": [
        { "label": "Confidence or feeling unsure about what I know and don’t know", "value": "confidence_uncertainty" },
        { "label": "Time or family commitments", "value": "time_family" },
        { "label": "Access to internet or computer", "value": "access_internet_computer" },
        { "label": "Accessibility needs (please share)", "value": "accessibility_needs", "has_text_input": true },
        { "label": "Other", "value": "other", "has_text_input": true },
        { "label": "Nothing comes to mind", "value": "none" }
      ]
    }
  ]
}

```

### value 命名规范

- 统一 **小写 + 下划线**：如 `very_confident`、`not_for_profits`；
- **在“题目作用域内唯一”** 即可（同一题下不能重复）；
- **tag可改、value 不要改**（value 是稳定主键，便于历史统计）；
- 后端有一份“打分规则表/JSON”把 `value → 分数` 映射好（不必下发给前端）。



## 三、用户填写问卷后，前端应该怎么提交数据？答案怎么处理？

#### 建议的前端提交格式（用户提交时）

以 key 为字段名，value 是选择项/文本内容：

```json

  "confidence_in_boards": ,			// key: "confidence_in_boards" value: not_confident
  "familiar_terms": [
    "companies",						// 选择了哪几个选项，就写哪几个value
    "not_for_profits"
  ],
  "interest_motivation": [
    "impact",
    { "value": "other", "text": "我想多了解规则" }
  ],
  "legal_familiarity": "very_familiar",
  ...
}
```

> 对于 “Other”，前端可以返回：

```
{ "value": "other", "text": "用户输入的自由文本" }
```

------

###  后端接收到这些数据后，干的事有：

#### 1）根据题目配置 `SURVEY_SCHEMA` 执行打分逻辑：

- **某些题直接根据 `value` 得分（如第1题、第4题）**
- **某些题根据选择项数量得分（如熟悉术语、是否见过财报）**
- **某些题不计分但用于标签/兴趣筛选**

在后端写一个统一的函数：

```sql
const score = evaluateSurveyAnswer(payload, SURVEY_SCHEMA);

// 后端用 key 映射每题的分值规则
const scoringRules = {
  confidence_in_boards: {
    type: 'single',
    points: { 1: 1, 2: 2, 3: 3 }
  },
  familiar_terms: {
    type: 'multi',
    point_per_item: 1
  }
```

------

#### 2）将结果写入数据库：

- `onboarding_surveys` 写一条总记录（user_id, submitted_at, total_score, level）
- `onboarding_survey_answers` 写每题一条（带原始答案、得分）
- 如果是多选题或 other 选项，写入 `onboarding_survey_options`



## 四、用户的答案怎么存储？能否区分单选、多选、多选的other？

存储答案必须考虑：

- ✅ **单选题** vs **多选题**
- ✅ **普通选项** vs **“Other + 自定义文本”**
- ✅ **值是 key 还是 score**

逐个拆解：

------

### （1）单选题如何存储？

假设题目是：

```json
{
  "key": "confidence_in_boards",
  "type": "single_choice",
  "options": [
    { "label": "Not at all confident", "value": "Not confident" },
    { "label": "Somewhat confident", "value": "Somewhat confident" },
    { "label": "Very confident", "value": "Very confident" }
  ]
}
```

用户选择：

```json
"confidence_in_boards": "Very confident"
```

存储结果：

```json
question_key     = 'confidence_in_boards'
answer_value     = "Very confident"
answer_text      = NULL		// 用户没有输入任何文本
```

------

### （2）多选题如何存储？

**多选题的选项必须另开一个表**

例如题目：

```json
{
  "key": "familiar_terms",
  "type": "multi_choice",
  "options": [...]
}
```

用户选择：

```json
"familiar_terms": ["companies", "social_enterprises"]
```

存储方式：

#### `onboarding_survey_answers` 中：

```json
question_key     = 'familiar_terms'
answer_value     = NULL			// 对于多选题，这两个字段都可以空着
answer_text      = NULL
```

#### 然后在 `onboarding_survey_options` 中存多条：

```json
(answer_id, option_value) = (..., 'companies')
(answer_id, option_value) = (..., 'social_enterprises')
```

### （3）“Other + 自定义文本”怎么处理？

用户提交：

```json
"interest_motivation": [ "getting_a_board_role",  { "value": "other", "text": "想了解组织结构" } ]
```

则可以：

#### 在 `onboarding_survey_options` 表中存：

```
(answer_id, option_value, text) = (..., 'getting_a_board_role', NULL)
(answer_id, option_value, text) = (..., 'other', '想了解组织结构')
```

这样就区分了是其他选项，还是其他+自定义内容。



### 问题4：为什么多选题的用户选项要单独建表？

### 为什么不能把多选答案放在主表的 `answer_value = ['x', 'y']`？

| 做法              | 查询麻烦              | 统计复杂          | 正确姿势 |
| ----------------- | --------------------- | ----------------- | -------- |
| 把数组存一列      | ❌ 查询需 `ANY()` 操作 | ❌ 聚合困难        | ❌        |
| 拆成一条条 option | ✅ WHERE 条件简单      | ✅ `GROUP BY` 简洁 | ✅        |

------

### 举例：统计“熟悉术语”中最多人选的选项

```sql
SELECT option_value, COUNT(*) 
FROM onboarding_survey_options
JOIN onboarding_survey_answers USING(answer_id)
WHERE question_key = 'familiar_terms'
GROUP BY option_value
ORDER BY COUNT(*) DESC;
```

你会得到：

| option_value       | count |
| ------------------ | ----- |
| companies          | 83    |
| not_for_profits    | 75    |
| social_enterprises | 60    |

### 五、为啥 `key` 用语义名，不用随机 id？

因为你的问卷是**固定 12 道**，用语义化 `key` 更清晰、易维护：

- 打分：`rules['confidence_in_boards']` 一眼可读
- 落库：`question_key='confidence_in_boards'` 查统计直观
- 日志/排错：看到 payload 立刻明白是哪题

随机 id（如 `q3981x`）适合“动态题库”，现在这个场景不需要自找麻烦。

------

### 六、前端到底需要哪些字段？那些“score_each / max_select”怎么处理？

别把后台规则塞到前端！**前后端分离两套 JSON**，前端只拿渲染必需的字段即可。

#### A. 后端内部“评测规则 JSON”（不下发）

用于打分，举例：

```json
[
  {
    "key": "confidence_in_boards",
    "type": "single_choice",
    "value_scores": { "not_at_all": 1, "somewhat": 2, "very": 3 }
  },
  {
    "key": "familiar_terms",
    "type": "multi_choice",
    "score_each": 1,
    "max_score": 5            // 可选：统计封顶
  },
  {
    "key": "interest_motivation",
    "type": "multi_choice",
    "max_select": 2,          // UI/校验都用得上
    "value_scores": {}        // 这题不计分就留空
  }
]
```

> 说明：
>
> - `value_scores`、`score_each` 属于**后端打分**逻辑，不必给前端。
> - `max_select` 前端需要，用来限制多选数量（也建议后端再校验一层）。

#### B. 前端“渲染用 JSON”（下发）

**只发 UI 必需：**

```json
"questions": [
    {
      "number": 1,		// 题目编号
      "key": "confidence_in_boards",	// 题目语义key
      "text": "How confident do you feel in knowing what boards do?",	// 题干
      "type": "single_choice",	// 题目类型
      "options": [		// 每个选项一个label 一个value
        { "label": "Not at all confident", "value": "not_confident" },
        { "label": "Somewhat confident",  "value": "somewhat_confident" },
        { "label": "Very confident",      "value": "very_confident" }
      ]
    },
    {
      "number": 2,
      "key": "familiar_terms",
      "text": "Which of these terms are you familiar with?",
      "type": "multi_choice",
      "min_select": 0,
      "options": [
        { "label": "Incorporated bodies",     "value": "incorporated_bodies" },
        { "label": "Companies",               "value": "companies" },
        { "label": "Not for profits",         "value": "not_for_profits" },
        { "label": "Community organisations", "value": "community_orgs" },
        { "label": "Social enterprises",      "value": "social_enterprises" }
      ]
    },
```

前端职责：渲染 UI、限制 `max_select`、对 `has_text_input` 的选项显示输入框。
 **不需要知道分值**。

## 前端如何判断题目里有没有 `max_select` / `has_text_input` 等字段？

这些字段是**可选**的，就用“存在性判断”。示例（TS/JS 都行）：

```js
type Option = {
  label: string;
  value: string;              // 机器可读值
  has_text_input?: boolean;   // 只有“其他”才会出现
};

type Question = {
  number: number;
  key: string;
  text: string;
  type: 'single_choice' | 'multi_choice' | 'text';
  options?: Option[];
  max_select?: number;        // 仅多选题才可能出现
};

// 判断是否多选并限制数量
function canSelectMore(q: Question, currentCount: number) {
  const limit = q.max_select ?? Infinity;         // 没有就视为无限制
  return q.type === 'multi_choice' && currentCount < limit;
}

// 渲染“其他”输入框
function optionNeedsInput(opt: Option) {
  return !!opt.has_text_input;                    // true 就展示一个文本输入
}
```

UI 层就按以上判断：

- `q.max_select ?? Infinity`：没有就不限制；
- `opt.has_text_input`：有就显示“其他说明”输入框。

### 七、 提交与入库示例

#### 前端提交（示例）：

```json
{
  "confidence_in_boards": "somewhat",
  "familiar_terms": ["companies","not_for_profits"],
  "interest_motivation": [
    "get_role",
    { "value": "other", "text": "想了解组织结构" }
  ],
  "...": "..."
}
```

#### 后端处理：

- 按 `rules` 计算得分：`somewhat -> 2`, 多选两项得 2 分等；
- 写 `onboarding_surveys` 一条（含 `total_score`, `level`）；
- 对每题写 `onboarding_survey_answers`（`answer_value`/`answer_text`/`answer_score`）；
- 多选题逐条写 `onboarding_survey_options`：
  - (`option_value`='get_role')
  - (`option_value`='other', `option_text`='想了解组织结构')

------

