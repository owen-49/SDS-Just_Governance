# Ⅰ. 主题小测（Topic Quiz）——页面内嵌、就地判分

> 交互：主题页“评测卡”内展开做题→提交后就地显示逐题对错、解析与总分；达标≥80%后可手动“标记已完成”。小测结果用于更新**user_topic_progress**，不进入“整体评测历史”。

### 1) 生成/获取待做小测题单（不建会话）

**POST** `/api/v1/topics/{topic_id}/quiz/pending`

- **作用**：首次打开小测卡时生成题单（或返回已生成但未提交的题单）；题目只存到用户的 **user_topic_progress.pending_quiz**，**不**写入 `assessment_sessions`。状态置为 `quiz_state=pending`。
- **返回**：`{ questions: [ { order_no, question_id, stem, choices } ], quiz_state:"pending" }`
- **读写表**：`questions` / `question_topics` 读；`user_topic_progress.pending_quiz` 写。

### 2) 提交小测并判分（落历史&更新进度）

**POST** `/api/v1/topics/{topic_id}/quiz/submit`

- **作用**：从 `pending_quiz` 取题，**此时才**创建一条 `assessment_sessions(kind='topic_quiz', topic_id=…)`，为每题写入 `assessment_items`（快照），再落 `assessment_responses` 判分、汇总 `total_score`。随后更新 `user_topic_progress` 的 `last_score/attempt_count/best_score/last_quiz_session_id`，并将 `quiz_state='completed'`、清空 `pending_quiz`。
- **入参**：`answers: [{order_no|item_id, answer}]`
- **返回**：`{ total_score, items:[{order_no, is_correct, correct_answer, explanation}], can_mark_complete: total_score>=threshold }`（阈值 80%/可配置）
- **读写表**：`assessment_sessions / assessment_items / assessment_responses` 写；`user_topic_progress` 更新。

> 注：**“标记为已完成”\**是\**模块/进度**模块的端点，不在测评组里实现；但此提交结果的 `best_score` 将决定是否允许用户标记完成。

------

# Ⅱ. 整体评测（Global Assessment）——右上角主按钮、弹窗三阶段

> 交互：说明页→作答页（支持逐题导航、可选“自动保存”）→结果页（总分/分项/AI总结/建议）。历史记录在“个人中心”。

### 3) 开始整体评测（创建会话+出题）

**POST** `/api/v1/assessments/global/start`

- **作用**：创建 `assessment_sessions(kind='global')`，抽题并写入 `assessment_items(question_snapshot)`；可返回首屏所需的题目页或全部题目（看前端分页策略）。支持记录 `last_question_index` 用于前端进度展示。
- **返回**：`{ session_id, items:[{item_id, order_no, snapshot:{qtype, stem, choices}}] }`
- **读写表**：`assessment_sessions / assessment_items` 写；读 `questions / question_topics`。

### 4) （可选）逐题保存/改答案（自动保存）

**POST** `/api/v1/assessments/{session_id}/answer`

- **作用**：作答过程中**即时保存**用户答案/变更；写入或更新 `assessment_responses(answer)`，客观题可实时回填 `is_correct`（若需即时对错），简答可先不评分。`last_question_index` 可同步更新。
- **返回**：`{ saved:true, progress:{answered, total, last_question_index} }`
- **读写表**：`assessment_responses` 写/更；`assessment_sessions.last_question_index` 更新。

### 5) 提交整体评测（汇总评分+AI总结）

**POST** `/api/v1/assessments/{session_id}/submit`

- **作用**：冻结会话，计算 `total_score`，填充 `submitted_at`，生成 `ai_summary/ai_recommendation`（后置异步亦可，先返回基础结果）。
- **返回**：`{ total_score, breakdown:[{topic_id|skill, score}], ai_summary?, ai_recommendation? }`（分档建议与阈值按你流程稿）
- **读写表**：更新 `assessment_sessions(total_score, submitted_at, ai_*)`；如需分项得分可从题目标签聚合。

### 6) 查看评测历史（个人中心）

**GET** `/api/v1/assessments/history`

- **作用**：列出用户历次 **global** 会话（分页）；用于“个人中心 > 测试记录”。
- **返回**：`[{session_id, started_at, submitted_at, total_score}]`
- **读写表**：读 `assessment_sessions(kind='global')`。

### 7) 查看某次评测详情（逐题回放）

**GET** `/api/v1/assessments/{session_id}`

- **作用**：取该次会话的 `items + responses`（你的答案/正确答案/解析），做“逐题回放”。
- **返回**：`{ session:{...}, items:[{order_no, snapshot, response:{answer, is_correct, score}}] }`
- **读写表**：读 `assessment_sessions / assessment_items / assessment_responses`。

------

## 错误与状态（统一壳即可）

- 未登录 `401`；重复提交或已提交会话再提交 `409`；字段错 `422`（前端消费 `data.errors`）；其余按全局规范。
- 主题小测：`pending_quiz` 不存在或已完成再提交 → `409`；提交成功后才产生会话记录（与你的设计保持一致）。

------

## 小结（给你拍板用）

- **主题小测**：2 个端点就够跑：`/quiz/pending` + `/quiz/submit`（不建会话→提交时建会话并判分→更新 user_topic_progress）。
- **整体评测**：最小也要 3 个：`/global/start`、`/{session}/submit`、`/history`；若要“自动保存”，再加一个 `/{session}/answer`。表落点全部对应你现有的 `assessment_*` 与 `user_topic_progress`。

如果你要我把这 7 个端点直接按你《接口文档规范》的格式产出（含请求/响应示例、错误码、字段约束），我现在就能给一版可发 PR 的草案。